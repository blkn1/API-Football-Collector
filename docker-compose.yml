version: "3.8"

services:
  postgres:
    image: postgres:15-alpine
    env_file:
      - ./.env
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-api_football}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Auto-load schemas on first init
      - ./db/schemas:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-api_football}"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - api_football_net

  redis:
    image: redis:7-alpine
    env_file:
      - ./.env
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - api_football_net

  # Scheduler: runs enabled non-live jobs from config/jobs/*.yaml
  collector:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - ./.env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/api_football}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-api_football}
      API_FOOTBALL_KEY: ${API_FOOTBALL_KEY}
      LOG_FILE: /app/logs/collector.jsonl
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "scripts/healthcheck_collector.py"]
      interval: 10s
      timeout: 5s
      retries: 12
    command: ["sh", "-lc", "python scripts/apply_schemas.py && python -m src.collector.scheduler"]
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - api_football_net

  # Optional: live polling loop (/fixtures?live=all every 15s).
  # Set ENABLE_LIVE_LOOP=1 to actually run it; otherwise the container stays idle (does NOT call API).
  live_loop:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - ./.env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/api_football}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-api_football}
      API_FOOTBALL_KEY: ${API_FOOTBALL_KEY}
      LOG_FILE: /app/logs/collector.jsonl
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      ENABLE_LIVE_LOOP: ${ENABLE_LIVE_LOOP:-0}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "scripts/healthcheck_live_loop.py"]
      interval: 10s
      timeout: 5s
      retries: 12
    command:
      [
        "sh",
        "-lc",
        "if [ \"${ENABLE_LIVE_LOOP:-0}\" = \"1\" ]; then python scripts/live_loop.py --interval 15; else echo 'live_loop disabled (set ENABLE_LIVE_LOOP=1)'; tail -f /dev/null; fi",
      ]
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - api_football_net

  # MCP server (read-only query interface)
  # For Claude Desktop: use stdio transport.
  # For Coolify: expose SSE transport via FASTMCP_HOST/FASTMCP_PORT and MCP_TRANSPORT=sse.
  mcp:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - ./.env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/api_football}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-api_football}
      COLLECTOR_LOG_FILE: /app/logs/collector.jsonl
      MCP_TRANSPORT: ${MCP_TRANSPORT:-sse}
      MCP_MOUNT_PATH: ${MCP_MOUNT_PATH:-}
      FASTMCP_HOST: ${FASTMCP_HOST:-0.0.0.0}
      FASTMCP_PORT: ${FASTMCP_PORT:-8000}
      FASTMCP_LOG_LEVEL: ${FASTMCP_LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      # IMPORTANT (Coolify): host port might already be in use on the server.
      # Override MCP_HOST_PORT in Coolify env if you see "port is already allocated".
      - "${MCP_HOST_PORT:-8001}:${FASTMCP_PORT:-8000}"
    healthcheck:
      test: ["CMD", "python", "scripts/healthcheck_mcp.py"]
      interval: 10s
      timeout: 5s
      retries: 12
    command: ["sh", "-lc", "python -m src.mcp.server"]
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - api_football_net

volumes:
  postgres_data:

networks:
  api_football_net:


